# PolyEdge æ—¶é—´å¥—åˆ©ç½‘ç»œæž¶æž„

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° PolyEdge çš„æ—¶é—´å¥—åˆ©ç½‘ç»œæž¶æž„ï¼Œé€šè¿‡ AWS VPC Peering å®žçŽ°ä½Žå»¶è¿Ÿæ•°æ®ä¼ è¾“ã€‚

## ç½‘ç»œæ‹“æ‰‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AWS å…¨çƒéª¨å¹²ç½‘                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ä¸œäº¬ VPC       â”‚          â”‚         çˆ±å°”å…° VPC               â”‚  â”‚
â”‚  â”‚   ap-northeast-1 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚         eu-west-1               â”‚  â”‚
â”‚  â”‚                  â”‚  VPC     â”‚                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ Peering  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Binance   â”‚  â”‚          â”‚  â”‚  PolyEdge  â”‚ â”‚ Polymarket  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  WebSocket â”‚â”€â”€â”¤          â”‚  â”‚  Engine    â”‚ â”‚   API       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚        â†“         â”‚          â”‚        â”‚                         â”‚  â”‚
â”‚  â”‚   ~5ms å»¶è¿Ÿ      â”‚          â”‚        â†“                         â”‚  â”‚
â”‚  â”‚                  â”‚          â”‚   ~1ms å»¶è¿Ÿ                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚                                  â”‚  â”‚
â”‚  â”‚  â”‚  Feeder    â”‚  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚  (UDP)     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚  UDP Feed â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æœåŠ¡å™¨ä¿¡æ¯

| æœåŠ¡å™¨ | å†…ç½‘ IP | å…¬ç½‘ IP | è§’è‰² |
|--------|---------|---------|------|
| ä¸œäº¬ | 172.31.44.26 | 57.180.89.145 | Binance æ•°æ®æº |
| çˆ±å°”å…° | 10.0.3.123 | 54.77.232.166 | æ‰§è¡Œå¼•æ“Ž |

## å»¶è¿Ÿåˆ†æž

### ç›®æ ‡é“¾è·¯å»¶è¿Ÿ

| é“¾è·¯ | å»¶è¿Ÿ | è¯´æ˜Ž |
|------|------|------|
| Binance â†’ ä¸œäº¬ | ~5ms | Binance æ–°åŠ å¡èŠ‚ç‚¹ |
| ä¸œäº¬ â†’ çˆ±å°”å…° (VPC) | ~1ms | AWS å†…ç½‘éª¨å¹²ç½‘ |
| çˆ±å°”å…° â†’ Polymarket | ~1.3ms | Polymarket æœåŠ¡å™¨ |
| **æ€»å‚è€ƒå»¶è¿Ÿ** | **~7ms** | ç†è®ºæœ€ä¼˜å€¼ |

### å¯¹æ¯”: å…¬ç½‘ç›´è¿ž

| é“¾è·¯ | å»¶è¿Ÿ |
|------|------|
| çˆ±å°”å…° â†’ Binance | ~150ms |
| çˆ±å°”å…° â†’ Polymarket | ~1.3ms |
| **æ€»å»¶è¿Ÿ** | **~151ms** |

**ç»“è®º**: VPC å†…ç½‘è½¬å‘æ¯”å…¬ç½‘ç›´è¿žå¿« **20å€ä»¥ä¸Š**ï¼

## æŠ€æœ¯å®žçŽ°

### 1. æ•°æ®æ ¼å¼ (Wire Protocol)

ä½¿ç”¨ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œ24 å­—èŠ‚/æ¶ˆæ¯ï¼š

```rust
// crates/poly_wire/src/lib.rs
struct WireBookTop {
    bid: f64,      // 8 å­—èŠ‚
    ask: f64,      // 8 å­—èŠ‚
    ts: u64,       // 8 å­—èŠ‚ (å¾®ç§’æ—¶é—´æˆ³)
}
```

### 2. ä¸œäº¬ç«¯: Binance è½¬å‘å™¨

**ä½ç½®**: `crates/feeder_tokyo/src/main.rs`

ä¼˜åŒ–ç‰¹æ€§:
- **16MB UDP å‘é€ç¼“å†²åŒº**: åº”å¯¹çªå‘æµé‡
- **DSCP ä¼˜å…ˆçº§**: æœ€é«˜ä¼˜å…ˆçº§ (EF, 46)
- **é¢„åˆ†é…ç¼–ç  buffer**: é¿å…æ¯æ¬¡åˆ†é…
- **äºŒè¿›åˆ¶åºåˆ—åŒ–**: bincode (æ¯” JSON å¿« 10 å€)

å¯åŠ¨å‘½ä»¤:
```bash
# è®¾ç½®ç›®æ ‡åœ°å€
export TARGET=10.0.3.123:6666
export SYMBOL=btcusdt

# è¿è¡Œ
cargo run -p feeder_tokyo
```

### 3. çˆ±å°”å…°ç«¯: UDP æŽ¥æ”¶å™¨

**ä½ç½®**: `crates/feed_udp/src/lib.rs`

ä¼˜åŒ–ç‰¹æ€§:
- **32MB UDP æŽ¥æ”¶ç¼“å†²åŒº**: åº”å¯¹çªå‘æµé‡å’ŒååŽ‹
- **ç«¯å£å¤ç”¨**: å¿«é€Ÿé‡å¯
- **é¢„åˆ†é… buffer**: 4KB é¢„åˆ†é…ï¼Œå¤ç”¨äºŽå°åŒ…
- **æ›´å¤§ channel**: 4096 å®¹é‡åº”å¯¹çªå‘
- **Gap æ£€æµ‹**: ç›‘æŽ§ä¸¢åŒ…

å¯åŠ¨: ç”± app_runner è‡ªåŠ¨å¯åŠ¨

## æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚

### Socket Buffer å¤§å°

```
å‘é€ç«¯ (ä¸œäº¬): 16MB
æŽ¥æ”¶ç«¯ (çˆ±å°”å…°): 32MB
```

å†…æ ¸é€šå¸¸ä¼šé™åˆ¶è¿™äº›å€¼ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯:
```bash
# Linux
cat /proc/sys/net/core/rmem_max
cat /proc/sys/net/core/wmem_max
```

å¦‚éœ€å¢žå¤§:
```bash
# ä¸´æ—¶
sysctl -w net.core.rmem_max=33554432
sysctl -w net.core.wmem_max=33554432

# æ°¸ä¹… ( /etc/sysctl.conf )
net.core.rmem_max=33554432
net.core.wmem_max=33554432
```

### DSCP ä¼˜å…ˆçº§

åœ¨ IP å¤´ä¸­è®¾ç½® Differentiated Services Code Point:
- EF (Expedited Forwarding): 46 - æœ€é«˜ä¼˜å…ˆçº§
- å‡å°‘ç½‘ç»œè®¾å¤‡ä¸­çš„æŽ’é˜Ÿå»¶è¿Ÿ

### ç½‘å¡ä¸­æ–­äº²å’Œæ€§ (å¯é€‰)

å¯¹äºŽæžè‡´ä½Žå»¶è¿Ÿï¼Œå¯ä»¥å°†ç½‘å¡ä¸­æ–­ç»‘å®šåˆ°ç‰¹å®š CPU:
```bash
# æŸ¥çœ‹ä¸­æ–­
cat /proc/interrupts | grep eth0

# ç»‘å®šåˆ° CPU 0
echo 1 > /proc/irq/<irq_num>/smp_affinity
```

## æµ‹è¯•æ–¹æ³•

### 1. å»¶è¿Ÿæµ‹è¯•è„šæœ¬

```bash
# æµ‹è¯• UDP å»¶è¿Ÿ (ä¸œäº¬ -> çˆ±å°”å…°)
python3 scripts/latency_test.py --mode udp --target 10.0.3.123 --port 6666

# æµ‹è¯• TCP å»¶è¿Ÿ
python3 scripts/latency_test.py --mode tcp --target 10.0.3.123 --port 6666

# æµ‹è¯•å…¬ç½‘ç›´è¿ž
python3 scripts/latency_test.py --mode direct
```

### 2. å®žæ—¶ç›‘æŽ§

åœ¨çˆ±å°”å…°æœåŠ¡å™¨æŸ¥çœ‹:
```bash
# æŸ¥çœ‹ UDP æŽ¥æ”¶ç»Ÿè®¡
ss -u -p

# æŸ¥çœ‹ç½‘ç»œå»¶è¿Ÿ
ping -c 100 172.31.44.26

# æŸ¥çœ‹ä¸¢åŒ…
netstat -su | grep -A5 "UDP"
```

### 3. å¯¹æ¯”æµ‹è¯•

åŒæ—¶å¼€å¯ä¸¤ç§æ¨¡å¼ï¼Œå¯¹æ¯”å»¶è¿Ÿå·®å¼‚:
- æ¨¡å¼ A: VPC å†…ç½‘ (é€šè¿‡ä¸œäº¬è½¬å‘)
- æ¨¡å¼ B: å…¬ç½‘ç›´è¿ž (ä»Žçˆ±å°”å…°ç›´æŽ¥è¿ž Binance)

é¢„æœŸç»“æžœ:
- VPC: ~7ms ç¨³å®š
- å…¬ç½‘: ~150ms æŠ–åŠ¨å¤§

## æ•…éšœæŽ’æŸ¥

### VPC è¿žé€šæ€§é—®é¢˜

```bash
# åœ¨ä¸œäº¬æµ‹è¯•
nc -zv 10.0.3.123 6666

# åœ¨çˆ±å°”å…°æµ‹è¯•
nc -zv 172.31.44.26 6666

# æ£€æŸ¥è·¯ç”±è¡¨
ip route show
```

### ä¸¢åŒ…é—®é¢˜

1. æ£€æŸ¥ç½‘å¡é”™è¯¯:
```bash
ethtool -S eth0 | grep -i error
```

2. æ£€æŸ¥ ring buffer:
```bash
ethtool -g eth0
```

3. å¢žåŠ  ring buffer:
```bash
ethtool -G eth0 rx 4096 tx 4096
```

## éƒ¨ç½²æ­¥éª¤

### 1. éªŒè¯ VPC Peering

ç¡®ä¿ä¸¤å°æœåŠ¡å™¨å¯ä»¥äº’é€š:
```bash
# ä¸œäº¬
ping -c 3 10.0.3.123

# çˆ±å°”å…°
ping -c 3 172.31.44.26
```

### 2. å¯åŠ¨ä¸œäº¬è½¬å‘å™¨

```bash
ssh -i dongjing.pem ubuntu@57.180.89.145

# ç¼–è¯‘
cd /opt/PolyEdge
cargo build -p feeder_tokyo --release

# å¯åŠ¨ (åŽå°)
export TARGET=10.0.3.123:6666
nohup ./target/release/feeder_tokyo > feeder.log 2>&1 &
```

### 3. å¯åŠ¨çˆ±å°”å…°å¼•æ“Ž

```bash
ssh -i PolyEdge.pem ubuntu@54.77.232.166

# ç¡®ä¿ UDP ç«¯å£å¼€æ”¾
sudo ufw allow 6666/udp

# å¯åŠ¨ PolyEdge
cargo run -p app_runner
```

### 4. éªŒè¯æ•°æ®æµ

```bash
# åœ¨çˆ±å°”å…°æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/polyedge.log

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼:
# ðŸ“Š UDP: 98 msg/s, 0 errors, 0 gaps
```

## æ‰©å±•: å¤šäº¤æ˜“å¯¹

å½“å‰é…ç½®æ”¯æŒå•ä¸ªäº¤æ˜“å¯¹ã€‚è¦æ‰©å±•åˆ°å¤šä¸ª:

1. åœ¨ä¸œäº¬ç«¯å¯åŠ¨å¤šä¸ª feeder å®žä¾‹ (ä¸åŒç«¯å£)
2. åœ¨çˆ±å°”å…°ç«¯å¯åŠ¨å¤šä¸ª UDP æŽ¥æ”¶å™¨
3. æˆ–ä¿®æ”¹åè®®æ”¯æŒå¤šäº¤æ˜“å¯¹å¤ç”¨

ç¤ºä¾‹:
```bash
# å¯åŠ¨ BTC
cargo run -p feeder_tokyo -- --symbol btcusdt --port 6666

# å¯åŠ¨ ETH (å¦ä¸€ä¸ªå®žä¾‹)
cargo run -p feeder_tokyo -- --symbol ethusdt --port 6667
```

## ç›‘æŽ§æŒ‡æ ‡

å…³é”®æŒ‡æ ‡ç›‘æŽ§:

1. **å»¶è¿Ÿ (Latency)**: Binance äº‹ä»¶åˆ°æŽ¥æ”¶çš„æ—¶é—´
2. **æŠ–åŠ¨ (Jitter)**: å»¶è¿Ÿçš„æ ‡å‡†å·®
3. **ä¸¢åŒ…çŽ‡ (Packet Loss)**: UDP Gap æ•°/æ€»æ¶ˆæ¯æ•°
4. **åžåé‡**: æ¶ˆæ¯æ•°/ç§’

å»ºè®®å‘Šè­¦é˜ˆå€¼:
- å»¶è¿Ÿ P99 > 15ms
- ä¸¢åŒ…çŽ‡ > 0.1%
- æŠ–åŠ¨ > 5ms
