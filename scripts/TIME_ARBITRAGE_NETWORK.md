# PolyEdge 时间套利网络架构

## 概述

本文档描述 PolyEdge 的正确时间套利网络架构。

**重要澄清**：
- Polymarket 服务器位于 **英国伦敦 (AWS eu-west-2)**
- Binance 存在新加坡节点
- 东京到伦敦物理距离约 9600 公里，延迟约 200ms

## 网络拓扑

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         AWS 全球骨干网                                    │
│                                                                         │
│  ┌──────────────────┐          ┌──────────────────────────────────────┐ │
│  │   东京 VPC       │          │         爱尔兰 VPC                   │ │
│  │   ap-northeast-1 │◄────────►│         eu-west-1                   │ │
│  │                  │  VPC     │                                      │ │
│  │                  │  ~206ms  │  ┌────────────┐ ┌────────────────┐ │ │
│  │  ┌────────────┐  │          │  │  PolyEdge  │ │  Polymarket    │ │ │
│  │  │  Binance   │──┤          │  │  Engine    │ │  (伦敦 eu-west-2)│ │
│  │  │  (新加坡)   │  5ms       │  │  (爱尔兰)   │ │    ~5ms        │ │ │
│  │  └────────────┘  │          │  └─────┬──────┘ └────────────────┘ │ │
│  │        ↓         │          │        │                            │ │
│  │   ~5ms 延迟      │          │   ~5ms 延迟                        │ │
│  │                  │          │                                      │ │
│  │  ┌────────────┐  │          │                                      │ │
│  │  │  Feeder    │──┼──────────┼────────────────────────────────────  │ │
│  │  │  (UDP)     │  │          │                                      │ │
│  │  └────────────┘  │          │                                      │ │
│  └──────────────────┘          └──────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 服务器信息

| 服务器 | 内网 IP | 公网 IP | 角色 |
|--------|---------|---------|------|
| 东京 | 172.31.44.26 | 57.180.89.145 | Binance 数据源 |
| 爱尔兰 | 10.0.3.123 | 54.77.232.166 | 执行引擎 |

## 延迟分析 (实测数据)

### 链路延迟 (实测)

| 链路 | 延迟 | 说明 |
|------|------|------|
| Binance (新加坡) → 东京 | ~5ms | WebSocket 本地连接 |
| 东京 → 爱尔兰 (VPC) | **~206ms** | AWS 内网骨干网 |
| 爱尔兰 → Polymarket (伦敦) | ~5ms | 隔壁 region |
| **总参考延迟** | **~216ms** | 数据传输 |

### 方案对比

| 方案 | 数据延迟 | 执行延迟 | 总延迟 | 稳定性 |
|------|----------|----------|--------|--------|
| **东京中继 (推荐)** | ~216ms | ~5ms | ~221ms | 极高 (0.265ms抖动) |
| 爱尔兰直连 | ~250ms | ~5ms | ~255ms | 一般 (公网抖动) |

**结论**: 东京中继比直连快 **~40ms**，且稳定性更高！

## 为什么"看到慢"没关系？

关键在于**下单速度**和**确定性**：

### 方案 A: 部署在东京 (错误)
- 看到价格: 0ms (本地)
- 下单到伦敦: ~220ms (跨区域)
- 问题: 子弹飞行的 220ms 里，伦敦盘口已变化多次

### 方案 B: 部署在爱尔兰 + 东京中继 (正确)
- 看到价格: ~216ms (中继数据)
- 下单到伦敦: ~5ms (隔壁)
- 优势: 虽然看到的是 216ms 前的价格，但对手看到的也是
- 确定性: 下单只需 5ms 就能确认成交

**核心**: 跨市场套利中，**执行端低延迟**远比**数据端低延迟**重要！

## 技术实现

### 1. 数据格式 (Wire Protocol)

24 字节/消息：
```rust
struct WireBookTop {
    bid: f64,    // 8 字节
    ask: f64,    // 8 字节
    ts: u64,     // 8 字节 (微秒)
}
```

### 2. 东京端: Binance 转发器

优化特性:
- **16MB UDP 发送缓冲区**
- **DSCP 优先级** (EF, 46)
- **预分配编码 buffer**
- **二进制序列化** (bincode)

### 3. 爱尔兰端: UDP 接收器

优化特性:
- **32MB UDP 接收缓冲区**
- **端口复用** (快速重启)
- **Gap 检测**
- **详细统计**

## 测试数据

### VPC 连通性测试

```
--- 172.31.44.26 ping statistics ---
20 packets transmitted, 20 received, 0% packet loss
rtt min/avg/max/mdev = 206.230/206.331/207.477/0.265 ms
```

关键指标:
- 延迟: ~206ms (稳定)
- 丢包率: 0%
- 抖动 (mdev): 0.265ms (极低)

### 公网直连对比

```
# 爱尔兰 → Binance (公网)
time_connect: 0.203006
time_appconnect: 0.609011

# 爱尔兰 → Polymarket
time_connect: 0.002833
time_appconnect: 0.022545
```

## 部署步骤

### 1. 验证 VPC Peering

```bash
# 在爱尔兰测试
ping -c 10 172.31.44.26

# 预期: ~206ms, 0% 丢包
```

### 2. 启动东京转发器

```bash
ssh -i dongjing.pem ubuntu@57.180.89.145

# 编译
cd /opt/PolyEdge
cargo build -p feeder_tokyo --release

# 启动
export TARGET=10.0.3.123:6666
nohup ./target/release/feeder_tokyo > feeder.log 2>&1 &
```

### 3. 启动爱尔兰引擎

```bash
ssh -i PolyEdge.pem ubuntu@54.77.232.166

# 编译
cargo build -p app_runner --release

# 启动
cargo run -p app_runner
```

## 监控指标

建议监控:
- 数据延迟: ~216ms (P99 < 250ms)
- 下单延迟: ~5ms (P99 < 10ms)
- 丢包率: < 0.01%
- 抖动: < 1ms

## 故障排查

### 问题: 延迟过高

1. 检查 VPC 路由表是否正确配置
2. 确认安全组允许 UDP 6666 端口
3. 测试 VPC 连通性: `ping 172.31.44.26`

### 问题: 丢包

1. 检查网卡错误: `ethtool -S eth0`
2. 增加 ring buffer: `ethtool -G eth0 rx 4096 tx 4096`
