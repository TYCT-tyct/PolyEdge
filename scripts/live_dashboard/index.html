<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyEdge 实时研究仪表板</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b1020; --panel:#111a33; --text:#e8eefc; --sub:#9fb0d4; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#29406f; }
    body { margin:0; font-family: "Microsoft YaHei", "PingFang SC", sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1500px; margin: 0 auto; padding: 14px; }
    .head { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .title { font-size: 22px; font-weight:700; }
    .sub { color:var(--sub); font-size:13px; }
    .grid { display:grid; grid-template-columns: repeat(12,1fr); gap:12px; margin-top:12px; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:12px; }
    .kpi { grid-column: span 3; }
    .chart { grid-column: span 8; }
    .decision { grid-column: span 4; }
    .log { grid-column: span 7; }
    .heatmap { grid-column: span 5; overflow:auto; }
    .full { grid-column: span 12; }
    .label { color:var(--sub); font-size:12px; }
    .value { font-size:20px; font-weight:700; margin-top:4px; }
    .ok { color:var(--ok); } .warn { color:var(--warn); } .bad { color:var(--bad); }
    select, button { background:#0b1328; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:6px 8px; }
    table { width:100%; border-collapse: collapse; font-size:12px; }
    th, td { border-bottom:1px solid #22355d; padding:6px; text-align:left; }
    th { color:var(--sub); position: sticky; top: 0; background: #121b36; }
    .hm td, .hm th { text-align:center; padding:4px; }
    .small { font-size:11px; color:var(--sub); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div>
      <div class="title">PolyEdge 实时研究仪表板（BTC 5m/15m）</div>
      <div class="sub">100ms 采样采集 | 实时信号/建议/交易日志/PNL/热力图</div>
    </div>
    <div>
      <span class="sub">连接状态：</span><span id="conn" class="warn">连接中...</span>
      <span class="sub" style="margin-left:10px;">更新时间：</span><span id="ts">-</span>
    </div>
  </div>

  <div class="grid">
    <div class="card kpi">
      <div class="label">BTC 价格</div><div id="kpiBtc" class="value">-</div>
      <div class="small">Binance 实时</div>
    </div>
    <div class="card kpi">
      <div class="label">总权益 / 已实现PNL</div><div id="kpiPnl" class="value">-</div>
      <div id="kpiPnlSub" class="small">-</div>
    </div>
    <div class="card kpi">
      <div class="label">风险进度</div><div id="kpiRisk" class="value">-</div>
      <div class="small">日亏损 / 熔断阈值</div>
    </div>
    <div class="card kpi">
      <div class="label">当前暴露</div><div id="kpiExpo" class="value">-</div>
      <div class="small">YES / NO</div>
    </div>

    <div class="card chart">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div><b>实时曲线（BTC vs 目标价 + YES/NO）</b></div>
        <div>
          <label class="small">市场：</label>
          <select id="marketSelect"></select>
        </div>
      </div>
      <canvas id="mainChart" height="120"></canvas>
    </div>

    <div class="card decision">
      <b>决策面板</b>
      <div class="small" id="decisionTitle" style="margin-top:8px;">-</div>
      <table style="margin-top:8px;">
        <tr><td class="label">推荐操作</td><td id="dAction">-</td></tr>
        <tr><td class="label">原因</td><td id="dReason">-</td></tr>
        <tr><td class="label">Net EV (YES / NO)</td><td id="dEv">-</td></tr>
        <tr><td class="label">P(UP)</td><td id="dProb">-</td></tr>
        <tr><td class="label">Delta / Velocity / Accel</td><td id="dDyn">-</td></tr>
        <tr><td class="label">剩余时间</td><td id="dRemain">-</td></tr>
        <tr><td class="label">持仓</td><td id="dPos">-</td></tr>
      </table>
    </div>

    <div class="card log">
      <b>交易日志（实时）</b>
      <div style="max-height:340px;overflow:auto;margin-top:8px;">
        <table>
          <thead><tr><th>时间</th><th>市场</th><th>动作</th><th>方向</th><th>价格</th><th>数量</th><th>原因</th><th>PNL</th></tr></thead>
          <tbody id="tradeRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card heatmap">
      <b>历史胜率热力图（横轴: Delta，纵轴: 剩余时间）</b>
      <div class="small" style="margin-top:4px;">颜色越绿表示历史 UP 胜率越高</div>
      <div id="heatmapWrap" style="margin-top:8px;"></div>
    </div>

    <div class="card full">
      <b>下一步操作建议</b>
      <div id="nextStep" style="margin-top:8px;">等待数据...</div>
    </div>
  </div>
</div>

<script>
let snapshot = null;
let selectedMarket = null;
let chart = null;

function fmt(n, d=4) {
  if (n === null || n === undefined || Number.isNaN(Number(n))) return "-";
  return Number(n).toFixed(d);
}
function colorRate(v){
  if (v===null || v===undefined) return "#24385f";
  const x=Math.max(0,Math.min(1,Number(v)));
  const r=Math.round((1-x)*230);
  const g=Math.round(x*190+40);
  const b=Math.round((1-x)*60);
  return `rgb(${r},${g},${b})`;
}

function ensureChart(){
  if (chart) return;
  chart = new Chart(document.getElementById("mainChart"), {
    type: "line",
    data: { labels: [], datasets: [
      {label:"BTC", data:[], yAxisID:"yBtc", borderColor:"#22d3ee", pointRadius:0, tension:0.1},
      {label:"Target", data:[], yAxisID:"yBtc", borderColor:"#f59e0b", pointRadius:0, borderDash:[6,4], tension:0},
      {label:"YES%", data:[], yAxisID:"yProb", borderColor:"#60a5fa", pointRadius:0, tension:0.1},
      {label:"NO%", data:[], yAxisID:"yProb", borderColor:"#f87171", pointRadius:0, tension:0.1}
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:"index",intersect:false},
      scales:{
        yBtc:{type:"linear",position:"left",grid:{color:"#22355d"}},
        yProb:{type:"linear",position:"right",min:0,max:100,grid:{drawOnChartArea:false}}
      },
      plugins:{legend:{labels:{color:"#dbe7ff"}}}
    }
  });
}

function renderHeatmap(hm){
  if (!hm) return;
  const wrap=document.getElementById("heatmapWrap");
  const d=hm.delta_bins||[];
  const r=hm.remaining_bins||[];
  const m=hm.matrix||[];
  let html='<table class="hm"><thead><tr><th>剩余\\Delta</th>';
  for(let i=0;i<d.length-1;i++){ html+=`<th>${d[i]}~${d[i+1]}%</th>`; }
  html+='</tr></thead><tbody>';
  for(let y=0;y<r.length-1;y++){
    html+=`<tr><th>${r[y]}~${r[y+1]}s</th>`;
    for(let x=0;x<d.length-1;x++){
      const v=(m[y]||[])[x];
      const txt=(v===null||v===undefined)?'-':(v*100).toFixed(1)+'%';
      html+=`<td style="background:${colorRate(v)}">${txt}</td>`;
    }
    html+='</tr>';
  }
  html+='</tbody></table>';
  wrap.innerHTML=html;
}

function renderTrades(rows){
  const body=document.getElementById("tradeRows");
  body.innerHTML=(rows||[]).slice(0,120).map(r=>`
    <tr>
      <td>${(r.ts_iso||"").replace("T"," ").slice(11,19)}</td>
      <td>${r.market_id||"-"}</td>
      <td>${r.action||"-"}</td>
      <td>${r.side||"-"}</td>
      <td>${fmt(r.price,4)}</td>
      <td>${fmt(r.qty_shares,3)}</td>
      <td>${r.reason||"-"}</td>
      <td>${fmt(r.realized_pnl,4)}</td>
    </tr>`).join("");
}

function renderSnapshot(data){
  snapshot=data;
  document.getElementById("ts").textContent=data.ts_iso||"-";
  const s=data.summary||{};
  document.getElementById("kpiBtc").textContent=fmt(s.btc_price,2);
  document.getElementById("kpiPnl").textContent=`${fmt(s.equity,2)} / ${fmt(s.realized_pnl,2)}`;
  document.getElementById("kpiPnlSub").textContent=`未实现: ${fmt(s.unrealized_pnl,2)}`;
  document.getElementById("kpiRisk").textContent=`${fmt(s.daily_loss_pct,2)}% / ${fmt(s.daily_loss_stop_pct,2)}%`;
  document.getElementById("kpiExpo").textContent=`YES ${fmt(s.exposure_yes,2)} | NO ${fmt(s.exposure_no,2)}`;

  const markets=data.markets||[];
  const sel=document.getElementById("marketSelect");
  if (!selectedMarket && markets.length>0) selectedMarket=markets[0].market_id;
  sel.innerHTML=markets.map(m=>`<option value="${m.market_id}" ${m.market_id===selectedMarket?'selected':''}>${m.timeframe} | ${m.market_id}</option>`).join("");
  sel.onchange=()=>{selectedMarket=sel.value; renderSnapshot(snapshot);};

  const cur=markets.find(m=>m.market_id===selectedMarket) || markets[0];
  if (cur){
    selectedMarket=cur.market_id;
    document.getElementById("decisionTitle").textContent=`${cur.title||'-'} (${cur.market_id})`;
    document.getElementById("dAction").textContent=cur.recommendation||"-";
    document.getElementById("dReason").textContent=cur.reason||"-";
    document.getElementById("dEv").textContent=`YES ${fmt(cur.ev_yes,5)} / NO ${fmt(cur.ev_no,5)}`;
    document.getElementById("dProb").textContent=`${fmt((cur.p_up||0)*100,2)}%`;
    document.getElementById("dDyn").textContent=`${fmt(cur.delta_pct,3)}% / ${fmt(cur.velocity_bps_per_sec,2)} / ${fmt(cur.acceleration_bps_per_sec2,2)}`;
    document.getElementById("dRemain").textContent=`${fmt(cur.remaining_sec,2)} s`;
    document.getElementById("dPos").textContent=`${cur.position_side||'无'} | qty=${fmt(cur.position_qty,3)}`;

    const series=cur.series||[];
    const t0=series.length?series[0].ts_ms:0;
    const labels=series.map(x=>((x.ts_ms-t0)/1000).toFixed(1));
    const yes=series.map(x=>x.yes==null?null:x.yes*100);
    const no=series.map(x=>x.yes==null?null:(1-x.yes)*100);
    const btc=series.map(x=>x.btc);
    const tgt=series.map(x=>x.target);
    ensureChart();
    chart.data.labels=labels;
    chart.data.datasets[0].data=btc;
    chart.data.datasets[1].data=tgt;
    chart.data.datasets[2].data=yes;
    chart.data.datasets[3].data=no;
    chart.update("none");

    document.getElementById("nextStep").textContent=
      `当前市场 ${cur.market_id} 建议: ${cur.recommendation}（${cur.reason}）。` +
      `若 EV 持续为正且速度方向不反转，维持持仓；若反向速度增强并触发阈值，执行卖出并切换。`;
  }

  renderTrades(data.trades||[]);
  renderHeatmap(data.heatmap);
}

async function pullOnce(){
  try{
    const r=await fetch('/api/snapshot');
    if (!r.ok) throw new Error('snapshot failed');
    const j=await r.json();
    renderSnapshot(j);
  }catch(e){}
}

function startWS(){
  const proto=location.protocol==='https:'?'wss':'ws';
  const ws=new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen=()=>{ document.getElementById("conn").textContent='已连接'; document.getElementById("conn").className='ok'; };
  ws.onclose=()=>{ document.getElementById("conn").textContent='断开，切换轮询'; document.getElementById("conn").className='warn'; setTimeout(startWS,2000); };
  ws.onerror=()=>{ document.getElementById("conn").textContent='错误，切换轮询'; document.getElementById("conn").className='bad'; };
  ws.onmessage=(ev)=>{ try{ renderSnapshot(JSON.parse(ev.data)); }catch(e){} };
}

setInterval(pullOnce, 1000);
pullOnce();
startWS();
</script>
</body>
</html>

